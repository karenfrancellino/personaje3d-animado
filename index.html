<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Droyz AR Experience</title>

<!-- A-Frame y AR.js -->
<script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
}

/* CONTROLES FIJOS (no desaparecen en iOS) */
.controls {
  position: fixed;
  bottom: 20px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 20px;
  z-index: 9999;
}

.btn {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  border: 4px solid white;
  background: rgba(0,0,0,0.7);
  color: white;
  font-size: 26px;
  cursor: pointer;
}

.recording {
  background: red !important;
}
</style>
</head>

<body>

<!-- ESCENA AR -->
<a-scene
  embedded
  vr-mode-ui="enabled: false"
  renderer="preserveDrawingBuffer: true; alpha: true;"
  arjs="sourceType: webcam; debugUIEnabled: false;"
>

<a-assets>
  <a-asset-item
    id="modelo"
    src="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb">
  </a-asset-item>
</a-assets>

<!-- LUCES -->
<a-entity light="type: ambient; intensity: 1.3"></a-entity>
<a-entity light="type: directional; position: 1 2 1"></a-entity>

<!-- C√ÅMARA + PERSONAJE PEGADO A LA PANTALLA -->
<a-entity camera id="camara">
  <a-entity
    id="personaje"
    gltf-model="#modelo"
    position="0 -0.8 -3"
    scale="2 2 2"
    animation-mixer
  ></a-entity>
</a-entity>

</a-scene>

<!-- BOTONES -->
<div class="controls">
  <button id="btnFoto" class="btn">üì∏</button>
  <button id="btnVideo" class="btn">üî¥</button>
</div>

<script>
const personaje = document.querySelector('#personaje');
const escena = document.querySelector('a-scene');
const btnVideo = document.querySelector('#btnVideo');

/* --------------------------------------------------
   MOVIMIENTO 2D (NO CAMBIA TAMA√ëO NI PROFUNDIDAD)
-------------------------------------------------- */
document.body.addEventListener('click', (e) => {
  const x = (e.clientX / window.innerWidth - 0.5) * 1.5;
  const y = -(e.clientY / window.innerHeight - 0.5) * 1;

  personaje.setAttribute('position', {
    x: x,
    y: y,
    z: -3 // Z FIJO ‚Üí el tama√±o no cambia
  });
});

/* --------------------------------------------------
   FOTO (SCREENSHOT)
-------------------------------------------------- */
document.querySelector('#btnFoto').onclick = () => {
  const canvas = escena.renderer.domElement;
  const enlace = document.createElement('a');
  enlace.download = 'Droyz_AR_Foto.png';
  enlace.href = canvas.toDataURL('image/png');
  enlace.click();
};

/* --------------------------------------------------
   VIDEO (LIMITADO EN iOS - MEJOR EN ANDROID)
-------------------------------------------------- */
let grabador;
let partes = [];

btnVideo.onclick = () => {
  if (!grabador || grabador.state === 'inactive') {
    const stream = escena.renderer.domElement.captureStream(30);
    grabador = new MediaRecorder(stream, { mimeType: 'video/webm' });

    grabador.ondataavailable = e => partes.push(e.data);
    grabador.onstop = () => {
      const blob = new Blob(partes, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Droyz_AR_Video.webm';
      a.click();
      partes = [];
    };

    grabador.start();
    btnVideo.classList.add('recording');
    btnVideo.textContent = '‚èπÔ∏è';
  } else {
    grabador.stop();
    btnVideo.classList.remove('recording');
    btnVideo.textContent = 'üî¥';
  }
};
</script>

</body>
</html>
