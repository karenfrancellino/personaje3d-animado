<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <style>
        .controls { position: fixed; bottom: 20px; width: 100%; display: flex; justify-content: space-around; z-index: 1000; }
        .btn { width: 70px; height: 70px; border-radius: 50%; border: none; background: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body style="margin:0; overflow:hidden;">
    <a-scene embedded vr-mode-ui="enabled: false" 
             arjs="sourceType: webcam; debugUIEnabled: false;"
             renderer="preserveDrawingBuffer: true; alpha: true; antialias: true;">
        
        <a-entity light="type: ambient; intensity: 1.5;"></a-entity>
        <a-entity light="type: directional; position: 1 1 1; intensity: 0.8;"></a-entity>

        <a-entity id="personaje" 
                  gltf-model="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb"
                  scale="2 2 2" 
                  position="0 -1.5 -4" 
                  animation-mixer
                  crossorigin="anonymous">
        </a-entity>

        <a-entity camera></a-entity>
    </a-scene>

    <div class="controls">
        <button id="btnFoto" class="btn">üì∏</button>
        <button id="btnVideo" class="btn" style="background: #ff4d4d; color: white;">‚óè</button>
    </div>

    <script>
        const boneco = document.querySelector('#personaje');
        const cena = document.querySelector('a-scene');

        // --- MOVIMENTA√á√ÉO SIMPLIFICADA (SEM PLANO INVIS√çVEL) ---
        // Agora o toque move o boneco em rela√ß√£o ao centro da tela
        document.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            // Sensibilidade do movimento
            const x = (touch.clientX / window.innerWidth - 0.5) * 6;
            const z = (touch.clientY / window.innerHeight - 0.5) * 6 - 4; // Mant√©m a profundidade original
            
            boneco.setAttribute('position', `${x} -1.5 ${z}`);
        });

        // --- FOTO (CORRE√á√ÉO DE CAMADA VAZIA) ---
        document.querySelector('#btnFoto').addEventListener('click', () => {
            const video = document.querySelector('video');
            const canvas3D = cena.renderer.domElement;
            const mergeCanvas = document.createElement('canvas');
            mergeCanvas.width = canvas3D.width;
            mergeCanvas.height = canvas3D.height;
            const ctx = mergeCanvas.getContext('2d');

            // 1. Desenha a c√¢mera (Realidade)
            ctx.drawImage(video, 0, 0, mergeCanvas.width, mergeCanvas.height);
            // 2. Desenha o personagem (3D) por cima
            ctx.drawImage(canvas3D, 0, 0);

            const link = document.createElement('a');
            link.download = 'droyz-foto.png';
            link.href = mergeCanvas.toDataURL('image/png');
            link.click();
        });

        // --- V√çDEO (FUS√ÉO DE CAMADAS) ---
        let gravador;
        let pedacos = [];
        const canvasFinal = document.createElement('canvas');
        const ctxFinal = canvasFinal.getContext('2d');

        document.querySelector('#btnVideo').addEventListener('click', function() {
            if (!gravador || gravador.state === 'inactive') {
                const video = document.querySelector('video');
                const canvas3D = cena.renderer.domElement;
                canvasFinal.width = canvas3D.width;
                canvasFinal.height = canvas3D.height;

                const stream = canvasFinal.captureStream(30);
                gravador = new MediaRecorder(stream, { mimeType: 'video/webm' });

                gravador.ondataavailable = e => pedacos.push(e.data);
                gravador.onstop = () => {
                    const blob = new Blob(pedacos, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'droyz-video.webm'; a.click();
                    pedacos = [];
                };

                gravador.start();
                this.textContent = "‚èπÔ∏è";

                function gravarFrame() {
                    if (gravador.state === 'recording') {
                        ctxFinal.drawImage(video, 0, 0, canvasFinal.width, canvasFinal.height);
                        ctxFinal.drawImage(canvas3D, 0, 0);
                        requestAnimationFrame(gravarFrame);
                    }
                }
                gravarFrame();
            } else {
                gravador.stop();
                this.textContent = "‚óè";
            }
        });
    </script>
</body>
</html>
