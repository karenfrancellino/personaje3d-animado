<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <style>
        .ui-container {
            position: fixed;
            bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
        }
        .btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            background: white;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>

<body style="margin:0; overflow:hidden;">
    <a-scene 
        embedded 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false; rayOrigin: mouse;"
        renderer="preserveDrawingBuffer: true; alpha: true; antialias: true;">

        <a-entity light="type: ambient; intensity: 0.8;"></a-entity>
        <a-entity light="type: directional; position: 1 2 1; intensity: 0.5;"></a-entity>

        <a-entity
            id="personaje"
            gltf-model="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb"
            scale="1.5 1.5 1.5"
            position="0 -1 -3"
            animation-mixer>
        </a-entity>

        <a-entity camera></a-entity>
        
        <a-plane id="piso" rotation="-90 0 0" width="100" height="100" visible="false" class="clickable"></a-plane>
    </a-scene>

    <div class="ui-container">
        <button id="btnFoto" class="btn">üì∏</button>
        <button id="btnVideo" class="btn" style="color: red;">‚óè</button>
    </div>

    <script>
        const scene = document.querySelector('a-scene');
        const personaje = document.querySelector('#personaje');
        const btnFoto = document.querySelector('#btnFoto');
        const btnVideo = document.querySelector('#btnVideo');

        // --- L√ìGICA DE MUDAR POSI√á√ÉO AO TOCAR ---
        scene.addEventListener('click', (event) => {
            // Pega a posi√ß√£o do clique atrav√©s da c√¢mera do A-Frame
            const touchPoint = event.detail.intersection ? event.detail.intersection.point : null;
            
            if (touchPoint) {
                // Mant√©m o personagem no "ch√£o" (Y fixo) mas move X e Z
                personaje.setAttribute('position', {
                    x: touchPoint.x,
                    y: -1, // Ajuste conforme a altura da sua c√¢mera
                    z: touchPoint.z
                });
            }
        });

        // --- DIN√ÇMICA DE MODELOS (STIKERS) ---
        const params = new URLSearchParams(window.location.search);
        const sticker = params.get('sticker');
        if (sticker === 'modelo2') {
            personaje.setAttribute('gltf-model', 'URL_DO_MODELO_2');
        }

        // --- L√ìGICA DE FOTO ---
        btnFoto.addEventListener('click', () => {
            const canvas = scene.renderer.domElement;
            const video = document.querySelector('video');
            const mergeCanvas = document.createElement('canvas');
            mergeCanvas.width = canvas.width;
            mergeCanvas.height = canvas.height;
            const ctx = mergeCanvas.getContext('2d');

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.drawImage(canvas, 0, 0);
            
            const link = document.createElement('a');
            link.download = 'droyz-capture.png';
            link.href = mergeCanvas.toDataURL('image/png');
            link.click();
        });

        // --- L√ìGICA DE V√çDEO (RESUMIDA) ---
        let mediaRecorder;
        let chunks = [];
        btnVideo.addEventListener('click', () => {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                const stream = scene.renderer.domElement.captureStream(30);
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/mp4' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'droyz-video.mp4';
                    a.click();
                    chunks = [];
                };
                mediaRecorder.start();
                btnVideo.textContent = "‚èπÔ∏è";
            } else {
                mediaRecorder.stop();
                btnVideo.textContent = "‚óè";
            }
        });
    </script>
</body>
</html>
