<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <style>
        .controls { position: fixed; bottom: 20px; width: 100%; display: flex; justify-content: space-around; z-index: 1000; }
        .btn { width: 70px; height: 70px; border-radius: 50%; border: none; background: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body style="margin:0; overflow:hidden;">
    <a-scene embedded vr-mode-ui="enabled: false" 
             arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;"
             renderer="preserveDrawingBuffer: true; alpha: true; antialias: true;">
        
        <a-entity light="type: ambient; intensity: 0.8;"></a-entity>
        <a-entity id="personaje" 
                  gltf-model="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb"
                  scale="2 2 2" position="0 -1 -5" animation-mixer></a-entity>

        <a-entity camera raycaster="objects: .clicavel" cursor="fuse: false; rayOrigin: mouse;"></a-entity>
        
        <a-plane id="chao" class="clicavel" rotation="-90 0 0" width="100" height="100" visible="false"></a-plane>
    </a-scene>

    <div class="controls">
        <button id="btnFoto" class="btn">üì∏</button>
        <button id="btnVideo" class="btn" style="background: #ff4d4d; color: white;">‚óè</button>
    </div>

    <script>
        const cena = document.querySelector('a-scene');
        const boneco = document.querySelector('#personaje');
        const chao = document.querySelector('#chao');

        // --- 1. CORRE√á√ÉO DA MOVIMENTA√á√ÉO ---
        cena.addEventListener('click', (ev) => {
            const intersecao = ev.detail.intersection;
            if (intersecao && intersecao.point) {
                // Move o boneco para o ponto exato onde voc√™ tocou no plano invis√≠vel
                boneco.setAttribute('position', {
                    x: intersecao.point.x,
                    y: -1, // Mant√©m na altura do ch√£o
                    z: intersecao.point.z
                });
            }
        });

        // --- 2. CORRE√á√ÉO DA FOTO (FUS√ÉO DE CAMADAS) ---
        document.querySelector('#btnFoto').addEventListener('click', () => {
            const video = document.querySelector('video');
            const canvas3D = cena.renderer.domElement;
            const mergeCanvas = document.createElement('canvas');
            mergeCanvas.width = canvas3D.width;
            mergeCanvas.height = canvas3D.height;
            const ctx = mergeCanvas.getContext('2d');

            // Desenha a c√¢mera primeiro, depois o 3D por cima
            ctx.drawImage(video, 0, 0, mergeCanvas.width, mergeCanvas.height);
            ctx.drawImage(canvas3D, 0, 0);

            const link = document.createElement('a');
            link.download = 'droyz-foto.png';
            link.href = mergeCanvas.toDataURL('image/png');
            link.click();
        });

        // --- 3. CORRE√á√ÉO DO V√çDEO (FUS√ÉO EM TEMPO REAL) ---
        let gravador;
        let pedacos = [];
        const canvasFinal = document.createElement('canvas');
        const ctxFinal = canvasFinal.getContext('2d');

        document.querySelector('#btnVideo').addEventListener('click', function() {
            if (!gravador || gravador.state === 'inactive') {
                const video = document.querySelector('video');
                const canvas3D = cena.renderer.domElement;
                canvasFinal.width = canvas3D.width;
                canvasFinal.height = canvas3D.height;

                const stream = canvasFinal.captureStream(30);
                gravador = new MediaRecorder(stream, { mimeType: 'video/webm' });

                gravador.ondataavailable = e => pedacos.push(e.data);
                gravador.onstop = () => {
                    const blob = new Blob(pedacos, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'droyz-video.webm'; a.click();
                    pedacos = [];
                };

                gravador.start();
                this.textContent = "‚èπÔ∏è";

                // Loop para fundir as imagens frame a frame
                function gravarFrame() {
                    if (gravador.state === 'recording') {
                        ctxFinal.drawImage(video, 0, 0, canvasFinal.width, canvasFinal.height);
                        ctxFinal.drawImage(canvas3D, 0, 0);
                        requestAnimationFrame(gravarFrame);
                    }
                }
                gravarFrame();
            } else {
                gravador.stop();
                this.textContent = "‚óè";
            }
        });
    </script>
</body>
</html>
